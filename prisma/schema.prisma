// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// 초대 신청 모델
model Invitation {
  id          String   @id @default(uuid())
  email       String   @unique
  companyName String?
  name        String
  status      String   @default("pending") // pending, approved, rejected
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([email])
  @@index([status])
  @@map("invitations")
}

// 고객 관리 모델
model Customer {
  id String @id @default(uuid())
  userId String // 컨설턴트 ID (Supabase Auth UID)

  // 사업자 정보
  businessNumber String @unique // 사업자등록번호 (10자리, 필수)
  businessType String // 'INDIVIDUAL' | 'CORPORATE' (개인사업자 | 법인사업자)
  corporateNumber String? // 법인등록번호 (13자리, 법인사업자만 해당)
  name String // 사업자명/상호

  // 기업 정보
  industry String?
  companySize String?
  location String?
  budget Int?

  // 니즈 정보
  challenges String[]
  goals String[]
  preferredKeywords String[] @default([]) // 영업자가 선택한 프로그램 기반 학습된 키워드

  // 연락처 정보
  contactEmail String?
  contactPhone String?

  // 기타
  notes String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Phase 4에서 MatchingResult 관계 추가 예정
  // matchingResults MatchingResult[]

  // 관심 프로그램 목록 (다대다 관계)
  watchlist CustomerProgram[]

  @@index([userId])
  @@index([businessNumber])
  @@index([businessType])
  @@index([industry])
  @@index([location])
  @@index([createdAt])
  @@map("customers")
}

// 정부지원사업 프로그램 모델
model Program {
  id String @id @default(uuid())

  // 다중 API 대응 필드
  dataSource  String // "기업마당", "K-Startup", "KOCCA-PIMS", "KOCCA-Finance"
  sourceApiId String // 각 API에서 제공하는 원본 ID

  // 기본 정보
  title           String
  description     String? // 프로그램 설명
  category        String?
  targetAudience  String[] // 대상 업종
  targetLocation  String[] // 대상 지역
  keywords        String[] // 키워드 배열
  budgetRange     String?
  deadline        DateTime?
  sourceUrl       String?
  attachmentUrl   String? // 첨부파일 URL (기업마당 API만 제공)
  rawData         Json // 원본 데이터 보관 (API별 차이 흡수)

  // 날짜 정보 (교차 정렬용)
  registeredAt DateTime // 등록일 (교차 정렬의 핵심 필드) ⭐
  startDate    DateTime?
  endDate      DateTime?

  // 동기화 메타데이터
  lastSyncedAt DateTime @default(now()) @updatedAt
  syncStatus   String   @default("active") // "active", "outdated", "deleted"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Phase 4에서 MatchingResult 관계 추가 예정
  // matchingResults MatchingResult[]

  // 관심 등록한 고객들 (다대다 관계)
  watchers CustomerProgram[]

  // 복합 인덱스 (검색 성능 향상)
  @@unique([dataSource, sourceApiId]) // 중복 방지
  @@index([registeredAt(sort: Desc)]) // 등록일 내림차순 정렬 (교차 노출용) ⭐
  @@index([dataSource, registeredAt(sort: Desc)]) // 출처별 정렬
  @@index([category])
  @@index([targetAudience])
  @@index([targetLocation])
  @@index([deadline])
  @@index([dataSource]) // API별 필터링
  @@index([lastSyncedAt]) // 동기화 추적
  @@map("programs")
}

// 동기화 메타데이터 모델 (증분 동기화용)
model SyncMetadata {
  id String @id @default(uuid())

  dataSource   String   @unique // "기업마당", "K-Startup", "KOCCA-PIMS", "KOCCA-Finance"
  lastSyncedAt DateTime // 마지막 동기화 시간 (증분 동기화의 기준점)
  syncCount    Int      @default(0) // 동기화 횟수
  lastResult   String? // 마지막 동기화 결과 (success, failed)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dataSource])
  @@index([lastSyncedAt])
  @@map("sync_metadata")
}

// 고객-프로그램 관심 목록 (다대다 중간 테이블)
model CustomerProgram {
  id String @id @default(uuid())

  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  customerId String

  program   Program @relation(fields: [programId], references: [id], onDelete: Cascade)
  programId String

  // 추가 정보
  addedAt DateTime @default(now()) // 관심 목록 추가 시간
  notes   String? // 메모

  @@unique([customerId, programId]) // 한 고객당 같은 프로그램 한 번만
  @@index([customerId])
  @@index([programId])
  @@index([addedAt])
  @@map("customer_programs")
}
